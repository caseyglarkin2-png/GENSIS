// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [postgis]
}

// ============================
// MULTI-TENANT ORGANIZATION MODELS
// ============================

enum OrganizationType {
  PLATFORM_ADMIN    // Freightroll
  CUSTOMER          // Primo, other customers
  PARTNER           // Integration partners
  
  @@map("organization_type")
}

model Organization {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  type             OrganizationType
  
  // White-label branding
  brandName        String?          @map("brand_name")
  logoUrl          String?          @map("logo_url")
  primaryColor     String?          @map("primary_color")
  customDomain     String?          @unique @map("custom_domain")
  
  // Business details
  industry         String?
  companySize      String?          @map("company_size")
  contactEmail     String?          @map("contact_email")
  contactPhone     String?          @map("contact_phone")
  
  // Subscription
  planTier         String           @default("starter") @map("plan_tier") // starter | professional | enterprise
  maxNetworks      Int?             @map("max_networks")
  maxFacilities    Int?             @map("max_facilities")
  maxUsers         Int?             @map("max_users")
  features         String[]         @default([]) // ai_insights | templates | api_access | white_label
  
  // Status
  isActive         Boolean          @default(true) @map("is_active")
  trialEndsAt      DateTime?        @map("trial_ends_at")
  subscriptionEndsAt DateTime?      @map("subscription_ends_at")
  
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  deletedAt        DateTime?        @map("deleted_at")
  
  users            OrganizationUser[]
  networks         Network[]
  templates        NetworkTemplate[]
  insights         AIInsight[]
  
  @@map("organizations")
  @@index([type])
  @@index([isActive])
  @@index([deletedAt])
}

enum UserRole {
  PLATFORM_ADMIN      // Freightroll super admins
  ORG_OWNER           // Customer org owner
  ORG_ADMIN           // Customer org admin
  NETWORK_MANAGER     // Can manage networks/facilities
  ANALYST             // Can view and analyze
  VIEWER              // Read-only access
  
  @@map("user_role")
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique
  name      String
  avatarUrl String?  @map("avatar_url")
  
  // Quick onboarding
  onboardingCompleted Boolean  @default(false) @map("onboarding_completed")
  onboardingStep      Int      @default(0) @map("onboarding_step")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  organizations OrganizationUser[]
  networks      Network[]
  auditLogs     AuditLog[]
  geometryVerifications FacilityGeometryVerification[]
  roiAssumptions RoiAssumption[]
  
  @@map("users")
  @@index([email])
  @@index([deletedAt])
}

model OrganizationUser {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  role           UserRole
  
  invitedAt      DateTime? @map("invited_at")
  joinedAt       DateTime? @map("joined_at")
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, userId])
  @@map("organization_users")
  @@index([userId])
  @@index([role])
}

// ============================
// TEMPLATE LIBRARY
// ============================

model NetworkTemplate {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String?  @map("organization_id") @db.Uuid // null = global Freightroll template
  
  name            String
  description     String?  @db.Text
  industry        String?  // logistics | retail | manufacturing | 3pl
  icon            String?
  
  // Template data
  facilityTypes   String[] @default([]) @map("facility_types")
  defaultMetrics  Json     @map("default_metrics")
  roiDefaults     Json     @map("roi_defaults")
  
  // Usage stats
  timesUsed       Int      @default(0) @map("times_used")
  isPublic        Boolean  @default(false) @map("is_public")
  isFeatured      Boolean  @default(false) @map("is_featured")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("network_templates")
  @@index([industry])
  @@index([isPublic, isFeatured])
}

// ============================
// AI INSIGHTS ENGINE
// ============================

enum InsightType {
  ANOMALY         // Unusual patterns detected
  RECOMMENDATION  // Suggested improvements
  PREDICTION      // Forecasted trends
  BENCHMARK       // Performance comparison
  ALERT           // Urgent attention needed
  
  @@map("insight_type")
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  
  @@map("insight_priority")
}

model AIInsight {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String          @map("organization_id") @db.Uuid
  networkId       String?         @map("network_id") @db.Uuid
  facilityId      String?         @map("facility_id") @db.Uuid
  
  type            InsightType
  priority        InsightPriority
  
  title           String
  description     String          @db.Text
  recommendation  String?         @db.Text
  
  // Supporting data
  dataPoints      Json?           @map("data_points")
  confidenceScore Float?          @map("confidence_score")
  
  // Actions
  isDismissed     Boolean         @default(false) @map("is_dismissed")
  isActionTaken   Boolean         @default(false) @map("is_action_taken")
  actionNotes     String?         @map("action_notes") @db.Text
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  expiresAt       DateTime?       @map("expires_at")
  
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  network         Network?        @relation(fields: [networkId], references: [id], onDelete: Cascade)
  facility        Facility?       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  
  @@map("ai_insights")
  @@index([organizationId])
  @@index([networkId])
  @@index([facilityId])
  @@index([type, priority])
  @@index([isDismissed, createdAt])
}

model Network {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String
  description    String?  @db.Text
  customerType   String?  @map("customer_type") // shipper | carrier | 3pl | warehouse_network
  
  // Created from template
  templateId     String?  @map("template_id") @db.Uuid
  
  createdBy      String   @map("created_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator        User         @relation(fields: [createdBy], references: [id])
  facilities     Facility[]
  roiAssumptions RoiAssumption[]
  insights       AIInsight[]
  
  @@map("networks")
  @@index([organizationId])
  @@index([name])
  @@index([deletedAt])
}

enum VerificationStatus {
  UNVERIFIED
  NEEDS_REVIEW
  VERIFIED
  
  @@map("verification_status")
}

model Facility {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  networkId         String             @map("network_id") @db.Uuid
  
  // Basic Info
  name              String
  facilityCode      String?            @map("facility_code")
  facilityType      String?            @map("facility_type")
  
  // Priority Flag (Primo Facilities)
  isPriority        Boolean            @default(false) @map("is_priority")
  priorityRank      Int?               @map("priority_rank") // 1-5 tier ranking
  priorityReason    String?            @map("priority_reason") @db.Text
  
  // Address
  address           String?            @map("address_line1")
  addressLine2      String?            @map("address_line2")
  city              String?
  state             String?
  zipCode           String?            @map("zip")
  country           String?            @default("USA")
  
  // Geometry - centroid stored as lat/lng for easy access
  centroidLat       Float?             @map("centroid_lat")
  centroidLng       Float?             @map("centroid_lng")
  polygonWKT        String?            @map("polygon_wkt") @db.Text
  // PostGIS geometry (used for spatial queries, synced with lat/lng)
  facilityCentroid  Unsupported("GEOMETRY(Point, 4326)")? @map("facility_centroid")
  facilityPolygon   Unsupported("GEOMETRY(Polygon, 4326)")? @map("facility_polygon")
  cannotPolygonReason String?          @map("cannot_polygon_reason") @db.Text
  
  // Verification
  verificationStatus VerificationStatus @default(UNVERIFIED) @map("verification_status")
  verificationConfidenceScore Int?     @map("verification_confidence_score")
  lastVerifiedAt    DateTime?          @map("last_verified_at")
  verifiedByUserId  String?            @map("verified_by_user_id") @db.Uuid
  
  // Import metadata
  importSource      String?            @map("import_source")
  importBatchId     String?            @map("import_batch_id") @db.Uuid
  geocodeMethod     String?            @map("geocode_method")
  geocodeConfidence Float?             @map("geocode_confidence")
  
  // Timestamps
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  deletedAt         DateTime?          @map("deleted_at")
  
  network           Network            @relation(fields: [networkId], references: [id], onDelete: Cascade)
  metrics           FacilityMetric?
  geometryVerifications FacilityGeometryVerification[]
  insights          AIInsight[]
  
  @@map("facilities")
  @@index([networkId])
  @@index([name])
  @@index([verificationStatus])
  @@index([deletedAt])
  @@index([isPriority])
}

enum MetricSource {
  manual
  import
  geocoder
  estimate
  integration
  
  @@map("metric_source")
}

model FacilityMetric {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId String   @unique @map("facility_id") @db.Uuid
  
  // Infrastructure (all follow pattern: value, confidence, source, last_verified_at, evidence_links)
  docksCount                          Int?        @map("docks_count")
  docksCountConfidence                Int?        @map("docks_count_confidence")
  docksCountSource                    MetricSource? @map("docks_count_source")
  docksCountLastVerifiedAt            DateTime?   @map("docks_count_last_verified_at")
  docksCountEvidenceLinks             String[]    @default([]) @map("docks_count_evidence_links")
  
  gatesCount                          Int?        @map("gates_count")
  gatesCountConfidence                Int?        @map("gates_count_confidence")
  gatesCountSource                    MetricSource? @map("gates_count_source")
  gatesCountLastVerifiedAt            DateTime?   @map("gates_count_last_verified_at")
  gatesCountEvidenceLinks             String[]    @default([]) @map("gates_count_evidence_links")
  
  yardSpotsCount                      Int?        @map("yard_spots_count")
  yardSpotsCountConfidence            Int?        @map("yard_spots_count_confidence")
  yardSpotsCountSource                MetricSource? @map("yard_spots_count_source")
  yardSpotsCountLastVerifiedAt        DateTime?   @map("yard_spots_count_last_verified_at")
  yardSpotsCountEvidenceLinks         String[]    @default([]) @map("yard_spots_count_evidence_links")
  
  trailersOnYardAvg                   Int?        @map("trailers_on_yard_avg")
  trailersOnYardAvgConfidence         Int?        @map("trailers_on_yard_avg_confidence")
  trailersOnYardAvgSource             MetricSource? @map("trailers_on_yard_avg_source")
  trailersOnYardAvgLastVerifiedAt     DateTime?   @map("trailers_on_yard_avg_last_verified_at")
  trailersOnYardAvgEvidenceLinks      String[]    @default([]) @map("trailers_on_yard_avg_evidence_links")
  
  // Throughput
  trucksPerDayInbound                 Int?        @map("trucks_per_day_inbound")
  trucksPerDayInboundConfidence       Int?        @map("trucks_per_day_inbound_confidence")
  trucksPerDayInboundSource           MetricSource? @map("trucks_per_day_inbound_source")
  trucksPerDayInboundLastVerifiedAt   DateTime?   @map("trucks_per_day_inbound_last_verified_at")
  trucksPerDayInboundEvidenceLinks    String[]    @default([]) @map("trucks_per_day_inbound_evidence_links")
  
  trucksPerDayOutbound                Int?        @map("trucks_per_day_outbound")
  trucksPerDayOutboundConfidence      Int?        @map("trucks_per_day_outbound_confidence")
  trucksPerDayOutboundSource          MetricSource? @map("trucks_per_day_outbound_source")
  trucksPerDayOutboundLastVerifiedAt  DateTime?   @map("trucks_per_day_outbound_last_verified_at")
  trucksPerDayOutboundEvidenceLinks   String[]    @default([]) @map("trucks_per_day_outbound_evidence_links")
  
  // Performance
  avgTurnTimeMinutes                  Int?        @map("avg_turn_time_minutes")
  avgTurnTimeMinutesConfidence        Int?        @map("avg_turn_time_minutes_confidence")
  avgTurnTimeMinutesSource            MetricSource? @map("avg_turn_time_minutes_source")
  avgTurnTimeMinutesLastVerifiedAt    DateTime?   @map("avg_turn_time_minutes_last_verified_at")
  avgTurnTimeMinutesEvidenceLinks     String[]    @default([]) @map("avg_turn_time_minutes_evidence_links")
  
  detentionMinutesPerTruck            Int?        @map("detention_minutes_per_truck")
  detentionMinutesPerTruckConfidence  Int?        @map("detention_minutes_per_truck_confidence")
  detentionMinutesPerTruckSource      MetricSource? @map("detention_minutes_per_truck_source")
  detentionMinutesPerTruckLastVerifiedAt DateTime? @map("detention_minutes_per_truck_last_verified_at")
  detentionMinutesPerTruckEvidenceLinks String[]  @default([]) @map("detention_minutes_per_truck_evidence_links")
  
  // Bottlenecks
  bottlenecks                         String[]    @default([])
  bottlenecksConfidence               Int?        @map("bottlenecks_confidence")
  bottlenecksSource                   MetricSource? @map("bottlenecks_source")
  bottlenecksLastVerifiedAt           DateTime?   @map("bottlenecks_last_verified_at")
  bottlenecksEvidenceLinks            String[]    @default([]) @map("bottlenecks_evidence_links")
  
  createdAt                           DateTime    @default(now()) @map("created_at")
  updatedAt                           DateTime    @updatedAt @map("updated_at")
  
  facility                            Facility    @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  
  @@map("facility_metrics")
}

model FacilityGeometryVerification {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facilityId          String   @map("facility_id") @db.Uuid
  
  // Geometry snapshot
  centroidSnapshot    Unsupported("GEOMETRY(Point, 4326)")? @map("centroid_snapshot")
  polygonSnapshot     Unsupported("GEOMETRY(Polygon, 4326)")? @map("polygon_snapshot")
  cannotPolygonReason String?  @map("cannot_polygon_reason") @db.Text
  
  // Verification details
  verificationMethod  String   @map("verification_method")
  confidenceScore     Int      @map("confidence_score")
  notes               String?  @db.Text
  
  // Who/when
  verifiedByUserId    String   @map("verified_by_user_id") @db.Uuid
  verifiedAt          DateTime @default(now()) @map("verified_at")
  
  facility            Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  verifiedBy          User     @relation(fields: [verifiedByUserId], references: [id])
  
  @@map("facility_geometry_verification")
  @@index([facilityId])
  @@index([verifiedAt])
}

model RoiAssumption {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  networkId       String   @map("network_id") @db.Uuid
  
  // Versioning
  version         String
  effectiveDate   DateTime @map("effective_date") @db.Date
  isActive        Boolean  @default(true) @map("is_active")
  
  // ROI Parameters (JSONB)
  assumptionsData Json     @map("assumptions_data")
  
  // Metadata
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  network         Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  creator         User     @relation(fields: [createdBy], references: [id])
  
  @@map("roi_assumptions")
  @@index([networkId])
  @@index([networkId, isActive])
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  
  // What action was taken
  action      String   @map("action")
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id") @db.Uuid
  
  // Change details
  changes     Json?    @map("changes")
  metadata    Json?    @map("metadata")
  
  // Who/when
  userId      String?  @map("user_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Context
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent") @db.Text
  
  user        User?    @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userId])
  @@index([action])
}
